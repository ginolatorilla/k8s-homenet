# -*- mode: ruby -*-
# vi: set ft=ruby :

# Kubernetes for Home Network provisioner
# Inspired by Artur Scheiner - artur.scheiner@gmail.com

CLUSTER_ENDPOINT = "api.k8s.home.net"
POD_CIDR = "172.18.0.0/16"

Vagrant.configure("2") do |config|
  config.vm.box = "starboard/ubuntu-arm64-20.04.5"
  config.vm.box_version = "20221120.20.40.0"
  config.vm.provider :vmware_desktop do |v, override|
    v.ssh_info_public = true
    v.gui = true
    v.vmx["ethernet0.virtualdev"] = "vmxnet3"
    v.vmx["ethernet0.connectiontype"] = "bridged"
  end

  config.vm.define "host-0-darwin-aarch64-k8s-master-0" do |node|
    node.vm.hostname = "host-0-darwin-aarch64-k8s-master-0"
    node.vm.provider :vmware_desktop do |v, override|
      v.vmx["numvcpus"] = "2"
      v.vmx["memsize"] = "2048"
      v.vmx["ethernet0.addressType"] = "static"
      v.vmx["ethernet0.address"] = "00:0C:29:93:79:0E"
    end

    node.vm.provision "install-app", type: "shell", path: "./scripts/install-k8s.sh", args: [CLUSTER_ENDPOINT, POD_CIDR]
  end

  config.vm.define "host0-darwin-aarch64-k8s-infra-0" do |node|
    node.vm.hostname = "host0-darwin-aarch64-k8s-infra-0"
    node.vm.provider :vmware_desktop do |v, override|
      v.vmx["numvcpus"] = "1"
      v.vmx["memsize"] = "1024"
      v.vmx["ethernet0.addressType"] = "static"
      v.vmx["ethernet0.address"] = "00:0C:29:09:7D:78"
    end

    node.vm.provision "install-app", type: "shell", path: "./scripts/install-haproxy.sh"
    node.vm.provision "put-config", after: "install-app", type: "file", source: "./etc/haproxy/haproxy.cfg", destination: "/tmp/etc/haproxy/haproxy.cfg"
    node.vm.provision "reload-config", after: "put-config", type: "shell", path: "./scripts/reload-haproxy.sh"
  end

  config.vm.define "host0-darwin-aarch64-dns" do |node|
    node.vm.hostname = "host0-darwin-aarch64-dns"
    node.vm.provider :vmware_desktop do |v|
      v.vmx["numvcpus"] = "1"
      v.vmx["memsize"] = "512"
      v.vmx["ethernet0.addressType"] = "static"
      v.vmx["ethernet0.address"] = "00:0C:29:69:2A:FB"
    end

    node.vm.provision "install-app", type: "shell", path: "./scripts/install-dns.sh"
    node.vm.provision "put-config", after: "install-app", type: "file", source: "./etc/dnsmasq.conf", destination: "/tmp/etc/dnsmasq.conf"
    node.vm.provision "reload-config", after: "put-config", type: "shell", path: "./scripts/reload-dns.sh"
  end

end
