---
- name: HA control plane - keepalived
  block:
    - name: Keepalived static pod manifest
      ansible.builtin.copy:
        src: files/etc/kubernetes/manifests/keepalived.yaml
        dest: /etc/kubernetes/manifests/keepalived.yaml
        mode: "0644"
    - name: Keepalived config directory
      ansible.builtin.file:
        path: /etc/keepalived
        state: directory
        mode: "0755"
      register: keepalived_config_dir
    - name: Keepalived config
      ansible.builtin.template:
        src: templates/etc/keepalived/keepalived.conf.j2
        dest: "{{ keepalived_config_dir.path }}/keepalived.conf"
        mode: "0644"
      vars:
        vip: "{{ control_plane_address }}"
    - name: Keepalived check script
      ansible.builtin.template:
        src: templates/etc/keepalived/check_server.sh.j2
        dest: "{{ keepalived_config_dir.path }}/check_server.sh"
        mode: "0744"
      vars:
        virtual_server_ip: "{{ control_plane_address }}"
        virtual_server_port: "{{ control_plane_port }}"

- name: HA control plane - haproxy
  block:
    - name: HAProxy static pod manifest
      ansible.builtin.copy:
        src: files/etc/kubernetes/manifests/haproxy.yaml
        dest: /etc/kubernetes/manifests/haproxy.yaml
        mode: "0644"
    - name: HAProxy config directory
      ansible.builtin.file:
        path: /etc/haproxy
        state: directory
        mode: "0755"
      register: haproxy_config_dir
    - name: Control node IPs
      ansible.builtin.setup:
      delegate_to: "{{ item }}"
      delegate_facts: true
      loop: "{{ groups.k8s_control_node_leader + groups.k8s_control_nodes }}"
    - name: HAProxy config
      ansible.builtin.template:
        src: templates/etc/haproxy.cfg.j2
        dest: "{{ haproxy_config_dir.path }}/haproxy.cfg"
        mode: "0644"

- name: Cluster bootstrapping
  ansible.builtin.command:
    cmd: kubeadm init --config {{ kubeadm.dest }}
    creates: /etc/kubernetes/manifests/kube*.yaml

- name: Get kubeconfig
  ansible.builtin.fetch:
    src: /etc/kubernetes/admin.conf
    dest: "{{ kubeconfig }}"
    flat: true
    mode: "0600"

- name: Remove taints
  ansible.builtin.command: >-
    kubectl taint node/{{ ansible_nodename }} node-role.kubernetes.io/control-plane-
  environment:
    KUBECONFIG: "{{ kubeconfig | expanduser }}"
  register: remove_taint
  changed_when: remove_taint.rc != 0
  delegate_to: localhost
  when: kubernetes_remove_taint
  become: false
  ignore_errors: true
