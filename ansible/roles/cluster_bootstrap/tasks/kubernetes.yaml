---
- name: Kubernetes binaries
  block:
    - name: Kubernetes apt repo signing keys
      ansible.builtin.apt_key:
        url: https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key
        keyring: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

    - name: Kubernetes apt repo
      ansible.builtin.apt_repository:
        repo: deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /
        state: present

    - name: Kubernetes packages
      ansible.builtin.apt:
        update_cache: true
        package:
          - kubelet
          - kubeadm
          - kubectl

- name: Kubelet as a systemd service
  ansible.builtin.systemd_service:
    name: kubelet
    enabled: true
    masked: false
    state: started

- name: Kubeadm config
  ansible.builtin.template:
    src: templates/etc/kubernetes/kubeadm.conf.j2
    dest: /etc/kubernetes/kubeadm.yaml
    mode: "0600"
  notify:
    - drain cluster
    - reset node

- name: Wait for handlers
  ansible.builtin.meta: flush_handlers

- name: Cluster bootstrapping
  ansible.builtin.command:
    cmd: kubeadm init --config /etc/kubernetes/kubeadm.yaml
    creates: /etc/kubernetes/manifests/*.yaml
  when: kubernetes_node_type == "control-leader"

- name: Join cluster
  when: kubernetes_node_type == "worker"
  block:
    - name: Generate join command
      ansible.builtin.shell:
        cmd: |-
          set -o pipefail
          if [ "$(kubeadm token list | tail +2 | wc -l)" -gt 0 ]; then
            token="$(kubeadm token list | tail +2 | head -1 | awk '{print $1}')"
            hash="$(openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | \
              openssl dgst -sha256 -hex | sed 's/^.* //')"
            echo kubeadm join {{ control_plane_endpoint }} --token $token --discovery-token-ca-cert-hash sha256:${hash}
          else
            kubeadm token create --print-join-command --description k8s-homenet
          fi
        executable: /bin/bash
      register: kubernetes_join_cmd
      changed_when: kubernetes_join_cmd.rc != 0
      delegate_to: lima-k8s-homenet-control-0
    - name: Run join command
      ansible.builtin.command:
        cmd: "{{ kubernetes_join_cmd.stdout }}"
        creates: /etc/kubernetes/pki/ca.crt
